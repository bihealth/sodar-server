{# Projectroles dependency #}
{% extends 'projectroles/project_base.html' %}

{% load static %}
{% load rules %}
{% load samplesheets_tags %}

{% block title %}
  Sample Sheets for {{ project.title }}
{% endblock title %}

{% block css %}
  {{ block.super }}
  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="{% static 'datatables/datatables.min.css' %}"/>
  <link rel="stylesheet" type="text/css" href="{% static 'datatables/DataTables-1.10.16/integration/dataTables.fontAwesome.css' %}"/>

  <style type="text/css">
    /* Special version of the container for samplesheets */
    div.omics-subtitle-container {
      padding-top: 10px;
      padding-bottom: 8px;
      // border-bottom: 1px solid #dfdfdf;
    }

    .omics-ss-assay-info-popup {
      max-width: 800px;
    }

    a.omics-ss-anchor {
      display: block;
      position: relative;
      top: -75px;
      visibility: hidden;
    }

    .omics-ss-init-container {
      height: 470px;
    }

    .omics-ss-data-table {
      border: 0 !important;
      min-width: 100%;
    }

    .omics-ss-data-table thead tr th {
      white-space: nowrap;
      padding: 5px;
      padding-right: 22px; /* Avoid covering sort icons */
      border-top: 0;
      border-right: 1px solid #dfdfdf;
      border-bottom: 1px solid #dfdfdf;
    }

    .omics-ss-data-table tbody tr td {
      white-space: nowrap;
      padding: 5px;
      margin: 0 !important;
    }

    .DTFC_RightBodyLiner {
      overflow-x: hidden;
    }

    .omics-ss-data-table tbody tr:last-child td {
      border-bottom: 0;
    }

    .omics-ss-data-table tbody tr td:first-child {
      border-left: 0 !important;
    }

    .DTFC_RightHeadBlocker {
        border-bottom: 1px solid #dfdfdf !important;
    }

    .DTFC_Cloned {
      border-left: 3px solid #dfdfdf !important;
    }

    .omics-ss-data-links-header {
      border-right: 0 !important;
    }

    .DTFC_Cloned thead tr:first-child th {
      border-bottom: 0 !important;
    }

    .DTFC_Cloned tbody tr td:first-child {
      border-left: 3px solid #dfdfdf !important;
    }

    .omics-ss-data-links-header {
      border-left: 3px solid #dfdfdf !important;
    }

    .omics-ss-data-btn-group {
      height: 1.25em;
    }

    .omics-ss-data-dropdown {
      margin-top: -3px !important; /* Force dropdown position */
      padding-top: 2px !important;
      height: 1.75em;
    }

    @media screen and (max-width: 1200px) {
      .omics-ss-nav {
        display: none;
      }
    }

  </style>
{% endblock css %}

{% block projectroles_extend %}

{% has_perm 'samplesheets.edit_sheet' request.user project as can_edit_sheet %}

<div class="row omics-subtitle-container omics-subtitle-shadow bg-white sticky-top">
  <h3><i class="fa fa-flask"></i> Sample Sheets</h3>

  {% if investigation %}
    <ul class="nav nav-pills omics-ss-nav ml-4 mr-auto">
      {% for s in investigation.studies.all %}
        {% get_study_title s as s_title %}
        <li class="nav-item">
          <a class="nav-link {% if s == study %}bg-success active{% endif %}"
             href="{% url 'samplesheets:project_sheets' study=s.omics_uuid %}"
             {% if s != study and s_title|length > 20 %}
               data-toggle="tooltip" data-placement="top" title="{{ s_title }}"
             {% endif %}>
            <i class="fa fa-list-alt"></i> {{ s_title|truncatechars:20 }}</a>
        </li>
      {% endfor %}
      <li class="nav-item">
        <a class="nav-link {% if subpage == 'info' %}bg-success active{% endif %}"
           href="{% url 'samplesheets:project_sheets' project=project.omics_uuid subpage='info' %}">
            <i class="fa fa-sitemap"></i> Overview</a>
      </li>
    </ul>
  {% endif %}

  <div class="ml-auto">
    {% if investigation %}
      {% include 'samplesheets/_nav_buttons.html' %}
    {% endif %}
    {% if can_edit_sheet %}
      {% include 'samplesheets/_list_buttons.html' %}
    {% endif %}
  </div>

</div>

<div class="container-fluid omics-page-container"> {# Main container #}

  {% if not investigation %}

    <div class="alert alert-info" role="alert">
      No sample sheets are currently available for this project.
      {% if can_edit_sheet %}
        To add sample sheets, please import it from ab existing ISAtab investigation.
      {% endif %}
    </div>

  {% else %}

    {% if table_data.study %}

      {# Details #}
      {% comment %}
      <div class="card">
        <div class="card-header">
          <h4>Study Details</h4>
        </div>
        {% include 'samplesheets/_study_info.html' %}
      </div>
      {% endcomment %}

      {# Study table #}
      <a class="omics-ss-anchor" id="{{ study.omics_uuid }}"></a>
      <div class="card omics-ss-data-card">
        <div class="card-header">
            <h4><i class="fa fa-fw fa-list-alt text-info"></i><span class="font-weight-bold text-info">Study</span> <span class="text-muted">|</span> {% get_study_title study %}
            <div class="input-group omics-header-input-group pull-right"
                 style="width: 320px;" table-id="{% get_table_id study %}">
              <div class="input-group-prepend">
                {# TODO: Include buttons from a separate file #}
                <button class="btn btn-secondary omics-ss-data-drag-toggle"
                        type="submit" id="omics-ss-data-drag-toggle-{{ study.omics_uuid }}"
                        data-toggle="tooltip" data-placement="top" title="Enable/disable drag scroll"
                        drag-mode="0"><i class="fa fa-mouse-pointer"></i></button>
                <button class="btn btn-secondary omics-ss-data-excel"
                        data-toggle="tooltip" data-placement="top" title="Download TSV file for Excel"
                        type="submit" id="omics-ss-data-drag-excel-{{ study.omics_uuid }}">
                        <i class="fa fa-file-excel-o"></i></button>
              </div>
              <input class="form-control omics-ss-data-filter"
                     type="text" placeholder="Filter" aria-label="Filter assay {{ assay.omics_uuid }}"
                     id="omics-ss-data-filter-{{ study.omics_uuid }}">
            </div>
          </h4>
        </div>
        <div class="card-body omics-card-body-table">
          <div class="table-responsive omics-ss-init-container">
            {% include 'samplesheets/_sheet_table.html' with table=table_data.study parent=study %}
          </div>
        </div>
      </div>

      {# Assay tables #}
      {% for assay in study.assays.all %}
        <a class="omics-ss-anchor" id="{{ assay.omics_uuid }}"></a>
        <div class="card omics-ss-data-card">
          <div class="card-header">
              <h4><i class="fa fa-fw fa-table text-danger"></i><span class="font-weight-bold text-danger">Assay</span> <span class="text-muted">|</span> {% get_assay_title assay %}
              <div class="input-group omics-header-input-group pull-right"
                   style="width: 360px;" table-id="{% get_table_id assay %}">
                <div class="input-group-prepend">
                  <button class="btn btn-secondary omics-ss-assay-hide"
                          type="submit" id="omics-ss-assay-hide-{{ assay.omics_uuid }}"
                          data-toggle="tooltip" data-placement="top" title="Show/hide study details"
                          assay-hide-mode="1"><i class="fa fa-eye-slash"></i></button>
                  <button class="btn btn-secondary omics-ss-data-drag-toggle"
                          type="submit" id="omics-ss-data-drag-toggle-{{ assay.omics_uuid }}"
                          data-toggle="tooltip" data-placement="top" title="Enable/disable drag scroll"
                          drag-mode="0"><i class="fa fa-mouse-pointer"></i></button>
                  <button class="btn btn-secondary omics-ss-data-excel"
                        data-toggle="tooltip" data-placement="top" title="Download TSV file for Excel"
                        type="submit" id="omics-ss-data-drag-excel-{{ study.omics_uuid }}">
                        <i class="fa fa-file-excel-o"></i></button>
                </div>
                <input class="form-control omics-ss-data-filter"
                       type="text" placeholder="Filter" aria-label="Filter assay {{ assay.omics_uuid }}"
                       id="omics-ss-data-filter-{{ assay.omics_uuid }}">
              </div>
            </h4>
          </div>
          <div class="card-body omics-card-body-table">
            <div class="table-responsive omics-ss-init-container">
              {% get_assay_table table_data assay as assay_table %}
              {% include 'samplesheets/_sheet_table.html' with table=assay_table parent=assay %}
            </div>
          </div>
        </div>
      {% endfor %}

    {% elif subpage == 'info' %}

      {# Information #}
      <div class="card">
        <div class="card-header">
          <h4>Investigation Details</h4>
        </div>
        {% include 'samplesheets/_investigation_info.html' with show_description=True %}
      </div>

      {# Statistics #}
      <div class="card">
        <div class="card-header">
          <h4>Investigation Statistics</h4>
        </div>
        <div class="card-body omics-card-body-table">
          <div class="table-responsive">
            <table class="table omics-card-table">
              <thead>
                <tr>
                  <th>Studies</th>
                  <th>Assays</th>
                  <th>Protocols</th>
                  <th>Processes</th>
                  <th>Sources</th>
                  <th>Materials</th>
                  <th>Samples</th>
                  <th>Data&nbsp;Files</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ sheet_stats.study_count }}</td>
                  <td>{{ sheet_stats.assay_count }}</td>
                  <td>{{ sheet_stats.protocol_count }}</td>
                  <td>{{ sheet_stats.process_count }}</td>
                  <td>{{ sheet_stats.source_count }}</td>
                  <td>{{ sheet_stats.material_count }}</td>
                  <td>{{ sheet_stats.sample_count }}</td>
                  <td>{{ sheet_stats.data_count }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    {% endif %}

  {% endif %}

</div> {# Main container #}

{% endblock projectroles_extend %}

{% block javascript %}
  {{ block.super }}

  <!-- DataTables -->
  <script type="text/javascript" src="{% static 'datatables/datatables.min.js'%}"></script>

  <!-- Dragscroll for tables -->
  <script type="text/javascript" src="{% static 'js/dragscroll.js' %}"></script>

  <script type="text/javascript">
    $(document).ready(function() {

        /************************
         * Initialize DataTables
         ************************/
        $('.omics-ss-data-table').DataTable({
            scrollY: 400,
            scrollX: true,
            paging: false,
            scrollCollapse: true,
            info: false,
            fixedColumns: {
                leftColumns: 0,
                rightColumns: 1
            },
            columnDefs: [
                {
                    // Disable sorting from links column
                    targets: [
                        'omics-ss-data-cell-links',
                        'omics-ss-data-links-header'],
                    orderable: false
                },
                {
                    targets: 'omics-ss-hideable-study',
                    visible: false
                }
                ],
            dom: 't' // Disable toolbar
        });

        // Once initialized, remove temporary init classes
        $('.omics-ss-init-container').removeClass('table-responsive').removeClass('omics-ss-init-container');

        /****************************
         * Enable/disable dragscroll
         ***************************/
        $('.omics-ss-data-drag-toggle').click(function() {
            if ($(this).attr('drag-mode') === '0') {
                $(this).find('i').addClass('text-warning');
                $(this).attr('drag-mode', '1');
                $(this).closest('.omics-ss-data-card').find('.dataTables_scrollBody').addClass('dragscroll');
                dragscroll.reset();
            }

            else {
                $(this).find('i').removeClass('text-warning');
                $(this).attr('drag-mode', '0');
                $(this).closest('.omics-ss-data-card').find('.dataTables_scrollBody').removeClass('dragscroll');
                dragscroll.reset();
            }
        });

        /**********************
         * Filtering
         **********************/

        $('.omics-ss-data-filter').keyup(function () {
            var tableId = $(this).closest('.input-group').attr('table-id');
            var dt = $('#' + tableId).dataTable();
            var v = $(this).val();
            dt.fnFilter(v);
        });

        /**********************
         * Study column hiding
        ***********************/

        // Hide/show study columns when clicked
        $('.omics-ss-assay-hide').click(function () {
            var tableId = $(this).closest('.input-group').attr('table-id');
            var dt = $('#' + tableId).DataTable();

            // Hide
            if ($(this).attr('assay-hide-mode') === '0') {
                $(this).find('i').removeClass('fa-eye').addClass('fa-eye-slash').removeClass('text-warning');
                dt.columns('.omics-ss-hideable-study').visible(false);
                $(this).attr('assay-hide-mode', '1');
            }

            // Show
            else {
                $(this).find('i').removeClass('fa-eye-slash').addClass('fa-eye').addClass('text-warning');
                dt.columns('.omics-ss-hideable-study').visible(true);
                $(this).attr('assay-hide-mode', '0');
            }
        });
    });
  </script>

  {# Tour content #}
  <script type="text/javascript">
    tourEnabled = false;
  </script>
{% endblock javascript %}
