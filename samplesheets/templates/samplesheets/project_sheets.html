{# Projectroles dependency #}
{% extends 'projectroles/project_base.html' %}
{% load projectroles_common_tags %}

{% load static %}
{% load rules %}
{% load samplesheets_tags %}

{% block title %}
  Sample Sheets for {{ project.title }}
{% endblock title %}

{% get_setting 'SHEETS_MAX_COLUMN_WIDTH' %}

{% block css %}
  {{ block.super }}

  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="{% static 'datatables/datatables.min.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'datatables/DataTables-1.10.16/integration/dataTables.fontAwesome.css' %}" />

  <style type="text/css">
    /* Special version of the container for samplesheets */
    div.sodar-subtitle-container {
      padding-top: 10px;
      padding-bottom: 8px;
      // border-bottom: 1px solid #dfdfdf;
    }

    .sodar-ss-assay-info-popup {
      max-width: 800px;
    }

    a.sodar-ss-anchor {
      display: block;
      position: relative;
      top: -75px;
      visibility: hidden;
    }

    .sodar-ss-init-container {
      height: 470px;
    }

    .sodar-ss-contentapp-container {
      padding-bottom: 1px !important;
    }

    .sodar-ss-data-table {
      border: 0 !important;
      min-width: 100% !important;
      width: 100% !important;
    }

    .sodar-ss-data-table thead tr th {
      white-space: nowrap;
      padding: 5px;
      border-top: 0;
      border-right: 1px solid #dfdfdf;
      border-bottom: 1px solid #dfdfdf;
    }

    .sodar-ss-data-table tbody tr td {
      border-right: 1px solid #dfdfdf;
    }

    th.sodar-ss-data-header {
      max-width: {% get_setting 'SHEETS_MAX_COLUMN_WIDTH' %}px;
    }

    td.sodar-ss-data-cell {
      max-width: {% get_setting 'SHEETS_MAX_COLUMN_WIDTH' %}px;
      padding: 2px;
    }

    .sodar-ss-data-table thead tr th:last-child {
      border-right: 0;
    }

    .sodar-ss-data-table thead tr.sodar-ss-header-row th {
      padding-right: 22px; /* Avoid covering sort icons */
    }

    .sodar-ss-data-table tbody tr td {
      white-space: nowrap;
      padding: 5px;
      margin: 0 !important;
    }

    .sodar-ss-data-table-contentapp tbody tr td {
      vertical-align: top !important;
      white-space: normal !important;
    }

    .DTFC_LeftBodyLiner {
      overflow-x: hidden !important;
      overflow-y: hidden !important;
    }

    .DTFC_RightBodyLiner {
      overflow-x: hidden !important;
      overflow-y: hidden !important;
    }

    .DTFC_RightBodyWrapper {
      background-color: #ffffff;
    }

    .sodar-ss-data-table tbody tr:last-child td {
      border-bottom: 0;
    }

    .sodar-ss-data-table-study thead tr th:first-child {
      border-left: 0 !important;
    }

    .sodar-ss-data-table-study thead tr th:last-child {
      border-right: 0 !important;
    }

    .sodar-ss-data-table tbody tr td:first-child {
      border-left: 0 !important;
    }

    .sodar-ss-data-table tbody tr td:last-child {
      border-right: 0 !important;
    }

    .DTFC_RightHeadBlocker {
        border-bottom: 1px solid #dfdfdf !important;
    }

    .DTFC_Cloned {
      border-left: 3px solid #dfdfdf !important;
      border-right: 1px solid #dfdfdf !important;
    }

    .sodar-ss-data-links-header {
      border-right: 0 !important;
    }

    .DTFC_Cloned thead tr:first-child th {
      border-bottom: 0 !important;
    }

    .DTFC_Cloned tbody tr td:first-child {
      border-left: 3px solid #dfdfdf !important;
    }

    .sodar-ss-data-links-header {
      border-left: 3px solid #dfdfdf !important;
    }

    .sodar-ss-data-dropdown {
      margin-top: -3px !important; /* Force dropdown position */
      padding-top: 2px !important;
      height: 1.75em;
    }

    @media screen and (max-width: 1200px) {
      .sodar-ss-nav {
        display: none;
      }
    }

  </style>
{% endblock css %}

{% block projectroles_extend %}
{% has_perm 'samplesheets.edit_sheet' request.user project as can_edit_sheet %}

{% include 'samplesheets/_sheet_page_header.html' %}

<div class="container-fluid sodar-page-container"> {# Main container #}

  {% if not investigation %}

    <div class="alert alert-info" role="alert" id="sodar-ss-alert-no-sheets">
      No sample sheets are currently available for this project.
      {% if can_edit_sheet %}
        To add sample sheets, please import it from ab existing ISAtab investigation.
      {% endif %}
    </div>

  {% else %}

    {% if render_error %}

      <div class="alert alert-danger" role="alert" id="sodar-ss-alert-render-error">
        Error rendering sample sheets, please check your ISAtab files. Exception:
        {{ render_error|truncatechars:512 }}
      </div>

    {% elif table_data.study %}

      {# Study plugin #}
      {% get_study_plugin study as study_plugin %}

      {# Study anchor #}
      <a class="sodar-ss-anchor" id="{{ study.sodar_uuid }}"></a>

      {# Study title #}
      {% include 'samplesheets/_section_title.html' with item=study section_type='study' content_plugin=study_plugin %}

      {# Details #}
      <div class="card">
        <div class="card-header">
          <h4>Study Details</h4>
        </div>
        {% include 'samplesheets/_study_info.html' %}
      </div>

      {# Include study template #}
      {% if study_plugin and study_plugin.study_template %}
        {% include study_plugin.study_template %}
      {% endif %}

      {# Study table #}

      <div class="card sodar-ss-data-card sodar-ss-data-card-study">
        <div class="card-header">
          {% include 'samplesheets/_sheet_table_header.html' with table_type='study' item=study content_plugin=study_plugin %}
        </div>
        <div class="card-body p-0">
          <div class="table-responsive sodar-ss-init-container">
            {% include 'samplesheets/_sheet_table.html' with table=table_data.study parent=study %}
          </div>
        </div>
      </div>

      {# Assay tables #}
      {% for assay in study.assays.all %}
        {# Get assay app plugin #}
        {% get_assay_plugin assay as assay_plugin %}

        {# Assay anchor #}
        <a class="sodar-ss-anchor" id="{{ assay.sodar_uuid }}"></a>

        {# Assay title #}
        {% include 'samplesheets/_section_title.html' with item=assay section_type='assay' content_plugin=assay_plugin %}

        {# Include study template #}
        {% if assay_plugin and assay_plugin.assay_template %}
          {% include assay_plugin.assay_template %}
        {% endif %}

        <div class="card sodar-ss-data-card sodar-ss-data-card-assay">
          <div class="card-header">
            {% include 'samplesheets/_sheet_table_header.html' with table_type='assay' item=assay content_plugin=assay_plugin %}
          </div>
          <div class="card-body p-0">
            <div class="table-responsive sodar-ss-init-container">
              {% get_assay_table table_data assay as assay_table %}
              {% include 'samplesheets/_sheet_table.html' with table=assay_table parent=assay %}
            </div>
          </div>
        </div>
      {% endfor %}

    {% endif %}

  {% endif %}

</div> {# Main container #}

{% endblock projectroles_extend %}

{% block javascript %}
  {{ block.super }}

  <!-- Settings for Javascript -->
  <script type="text/javascript">
    window.refreshCellOverflow = false;
    {% get_setting 'SHEETS_SHORTCUT_QUERY_LIMIT' as shortcut_query_limit %}
    window.shortcutQueryLimit = {{ shortcut_query_limit }};
  </script>

  <!-- DataTables -->
  <script type="text/javascript" src="{% static 'datatables/datatables.min.js' %}"></script>

  <!-- Samplesheets Javascript -->
  <script type="text/javascript" src="{% static 'samplesheets/js/samplesheets.js' %}"></script>

  <!-- Dragscroll for tables -->
  <script type="text/javascript" src="{% static 'js/dragscroll.js' %}"></script>

  {# Tour content #}
  <script type="text/javascript">
    tourEnabled = true;

    tour.addStep('sheet_info', {
        title: 'Sample Sheets',
        text: 'In this app you are able to access meta data regarding ' +
              'project samples, along with links to sample file mass storage ' +
              'in iRODS.',
        advanceOn: '.docs-link click',
        showCancelLink: true
    });

    // No sheets
    if ($('#sodar-ss-alert-no-sheets').length) {
        tour.addStep('no_sheets', {
            title: 'No Sample Sheets Available',
            text: 'No sample sheets have been imported for the project. ' +
                  'Users with sufficient permissions can import an ISA ' +
                  'investigation using the Sheet Operations menu.',
            attachTo: '#sodar-ss-buttons-op left',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });
    }

    // Sheets available
    else {
        tour.addStep('sheet_isa', {
            title: 'ISA Model',
            text: 'Sample data is represented according to the ISA ' +
                  '(Investigation/Study/Assay) specification. One project is ' +
                  'expected to contain one investigation, which contains one ' +
                  'or more studies, which in turn can consist of one or more ' +
                  'assays. One study and its assays are visualized per page ' +
                  'in this application.',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('sheet_navigation', {
            title: 'Sample Sheet Navigation',
            text: 'Navigate between studies and data overview using this ' +
                  'navigation bar.',
            attachTo: '.sodar-subtitle-container bottom',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('sheet_navigation_dropdown', {
            title: 'Sample Sheet Shortcuts',
            text: 'Shortcuts to project studies and assays can be accessed ' +
                  'in this dropdown menu.',
            attachTo: '#sodar-ss-nav-dropdown bottom',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        if ($('#sodar-ss-buttons-op').length) {
            tour.addStep('sheet_operations', {
                title: 'Sheet Operations',
                text: 'Authorized users can perform sheet-wide operations ' +
                      'such as iRODS directory creation in this menu.',
                attachTo: '#sodar-ss-buttons-op left',
                advanceOn: '.docs-link click',
                showCancelLink: true
            });
        }
    }

    if ($('.sodar-ss-data-card').length) {
        tour.addStep('study_data', {
            title: 'Study Data',
            text: 'This is a data table listing all the sources and samples ' +
                  'in the currently selected study.',
            attachTo: '.sodar-ss-data-card-study top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('assay_data', {
            title: 'Assay Data',
            text: 'Assay-specific processed and materials are described in ' +
                  'assay tables.',
            attachTo: '.sodar-ss-data-card-assay top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('data_controls', {
            title: 'Data Table Controls',
            text: 'Access data table controls in the table header.',
            attachTo: '.sodar-header-input-group top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('data_links', {
            title: 'iRODS Links',
            text: 'Links to sample data files in iRODS can be accessed in ' +
                  'this column. Note that an authorized user must first ' +
                  'create the iRODS directories for the project for these ' +
                  'controls to be enabled. Uploading new data is done using ' +
                  'the Landing Zones app.',
            attachTo: '.sodar-ss-popup-list-btn left',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });
    }

  </script>
{% endblock javascript %}
