{# Projectroles dependency #}
{% extends 'projectroles/project_base.html' %}

{% load rules %}
{% load samplesheets_tags %}

{% block title %}
  Sample Sheets for {{ project.title }}
{% endblock title %}

{% block css %}
  {{ block.super }}
  <style type="text/css">
    /* Special version of the container for samplesheets */
    div.omics-subtitle-container {
      padding-top: 10px;
      padding-bottom: 8px;
      // border-bottom: 1px solid #dfdfdf;
    }

    .omics-ss-nav-tabs {
      border-bottom: 0;
    }

    .omics-ss-nav-tabs li a {
      margin-bottom: -1px !important;
      border-bottom: 0 !important;
      height: 118%; /* HACK */
    }

    .omics-ss-data-container {
      max-height: 600px;
      overflow-y: scroll;
    }

    .omics-ss-data-table thead tr th {
      white-space: nowrap;
      padding: 5px; /* Demo "Excel" mode */
    }

    .omics-ss-data-table tbody tr td {
      white-space: nowrap;
      padding: 5px; /* Demo "Excel" mode */
    }

    .omics-ss-data-table tbody tr:last-child td {
        border-bottom: 0;
    }

    .omics-ss-data-table-btn {
      height: 1.75em;
      padding-top: 1px;
    }

    /* Screenshot HACK */
    .omics-ss-data-cell-links {
        width: 50px;
    }

    /* Screenshot HACK */
    .fixed-column {
        position: absolute;
        display: inline-block;
        width: 60px;
        right: 0;
        border-left: 1px solid #f5f5f5 !important;
    }

    @media screen and (max-width: 1000px) {
      .omics-ss-nav-tabs {
        display: none;
      }
    }

  </style>
{% endblock css %}

{% block projectroles_extend %}

{% has_perm 'samplesheets.edit_sheet' request.user project as can_edit_sheet %}

<div class="row omics-subtitle-container bg-white sticky-top">
  <h3><i class="fa fa-flask"></i> Sample Sheets</h3>

  {% if investigation and investigation.status == 'OK' %}
    <ul class="nav nav-tabs omics-ss-nav-tabs ml-4 mr-auto">
      {% for s in investigation.studies.all %}
        <li class="nav-item">
          <a class="nav-link {% if s == study %}bg-light active{% endif %}"
             href="{% url 'project_sheets' project=project.pk study=s.pk %}">
              <i class="fa fa-list-alt"></i> {% get_study_title s %}</a>
        </li>
      {% endfor %}
      <li class="nav-item">
        <a class="nav-link {% if subpage == 'info' %}bg-light active{% endif %}"
           href="{% url 'project_sheets' project=project.pk subpage='info' %}">
            <i class="fa fa-sitemap"></i> Overview</a>
      </li>
    </ul>
  {% endif %}

  <div class="ml-auto">
    {% if investigation %}
      {% include 'samplesheets/_nav_buttons.html' %}
    {% endif %}
    {% if can_edit_sheet %}
      {% include 'samplesheets/_list_buttons.html' %}
    {% endif %}
  </div>

</div>

<div class="container-fluid omics-page-container"> {# Main container #}

  {% if not investigation %}

    <div class="alert alert-info" role="alert">
      No sample sheets are currently available for this project.
      {% if can_edit_sheet %}
        To add sample sheets, please import it from ab existing ISAtab investigation.
      {% endif %}
    </div>

  {% elif investigation and investigation.status != 'OK' %}
    <div class="alert alert-warning" role="warning">
      Sample sheet importing in progress. Please <a href="{% url 'project_sheets' project=project.pk %}">reload</a> the page to
      see the status (javascript status update coming soon).
    </div>

  {% elif investigation and investigation.status == 'OK' %}

    {% if study %}

      {# Information #}
      <div class="card">
        <div class="card-header">
          <h4>Study Details</h4>
        </div>
        {% include 'samplesheets/_study_info.html' %}
      </div>

      {# Study overview table #}
      <div class="card omics-ss-data-card" id="study{{ study.pk }}">
        <div class="card-header">
          <h4>Study Overview
            {# HACK for demo screenshots #}
            <div class="input-group omics-header-input-group pull-right" style="width: 160px;">
              <input class="form-control"
                     type="text" placeholder="Filter" aria-label="Filter assay {{ assay.pk }}"
                     id="omics-ss-assay-filter-{{ assay.pk }}">
            </div>
          </h4>
        </div>
        <div class="card-body omics-card-body-table">
          <div class="table-responsive omics-ss-data-container">
            {% include 'samplesheets/_sheet_table.html' with table=study.render_table %}
          </div>
        </div>
      </div>

      {# Assay tables #}
      {% for assay in study.assays.all %}
        <div class="card omics-ss-data-card" id="assay{{ assay.pk }}">
          <div class="card-header">
            <h4>Assay {% get_assay_title assay %}
              <div class="input-group omics-header-input-group pull-right">
                <div class="input-group-prepend">
                  <button class="btn btn-secondary omics-ss-assay-hide"
                          type="submit" id="omics-ss-assay-hide-{{ assay.pk }}"
                          assay-hide-mode="1"><i class="fa fa-eye-slash"></i> Toggle Study</button>
                </div>
                <input class="form-control"
                       type="text" placeholder="Filter" aria-label="Filter assay {{ assay.pk }}"
                       id="omics-ss-assay-filter-{{ assay.pk }}">
              </div>
            </h4>
          </div>
          <div class="card-body omics-card-body-table">
            <div class="table-responsive omics-ss-data-container">
              {% include 'samplesheets/_sheet_table.html' with table=assay.render_table %}
            </div>
          </div>
        </div>
      {% endfor %}

    {% elif subpage == 'info' %}

      {# Information #}
      <div class="card">
        <div class="card-header">
          <h4>Investigation Details</h4>
        </div>
        {% include 'samplesheets/_investigation_info.html' with show_description=True %}
      </div>

      {# Statistics #}
      <div class="card">
        <div class="card-header">
          <h4>Investigation Statistics</h4>
        </div>
        <div class="card-body omics-card-body-table">
          <div class="table-responsive">
            <table class="table omics-card-table">
              <thead>
                <tr>
                  <th>Studies</th>
                  <th>Assays</th>
                  <th>Protocols</th>
                  <th>Processes</th>
                  <th>Sources</th>
                  <th>Materials</th>
                  <th>Samples</th>
                  <th>Data&nbsp;Files</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ sheet_stats.study_count }}</td>
                  <td>{{ sheet_stats.assay_count }}</td>
                  <td>{{ sheet_stats.protocol_count }}</td>
                  <td>{{ sheet_stats.process_count }}</td>
                  <td>{{ sheet_stats.source_count }}</td>
                  <td>{{ sheet_stats.material_count }}</td>
                  <td>{{ sheet_stats.sample_count }}</td>
                  <td>{{ sheet_stats.data_count }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    {% endif %}

  {% endif %}

</div> {# Main container #}

{% endblock projectroles_extend %}

{% block javascript %}
  {{ block.super }}

  <script type="text/javascript">
    $(document).ready(function() {
        /*
        // HACK for sxcreenshots: Fix links column position
        $('.omics-ss-data-table').each(function () {
            var $table = $(this);
            var $fixedColumn = $table.clone().insertBefore($table).addClass('fixed-column');
            $fixedColumn.find('th:not(:last-child),td:not(:last-child)').remove();

            $fixedColumn.find('tr').each(function (i, elem) {
                $(this).height($table.find('tr:eq(' + i + ')').height());
                });
            });
        */

        // Study column hiding
        // TODO: Cleanup/refactor this

        // Hide study columns by default
         $('.omics-ss-data-table').find('.omics-ss-hideable-study').hide();
         $('.omics-ss-top-header').each(function () {
             if ($(this).attr('omics-ss-hideable-study-cols') !== '0') {
                var colspan = $(this).attr('colspan');
                var hideCols = $(this).attr('omics-ss-hideable-study-cols');
                $(this).attr('colspan', colspan - hideCols);
             }
         });

        // Hide/show study columns when clicked
        $('.omics-ss-assay-hide').click(function () {
            // Hide
            if ($(this).attr('assay-hide-mode') === '0') {
                $(this).find('i').removeClass('fa-eye');
                $(this).find('i').addClass('fa-eye-slash');
                $(this).closest('.omics-ss-data-card').find('.omics-ss-data-table').find('.omics-ss-hideable-study').hide();
                $(this).closest('.omics-ss-data-card').find('.omics-ss-data-table').find('.omics-ss-top-header').each(function () {
                    if ($(this).attr('omics-ss-hideable-study-cols') !== '0') {
                        var colspan = $(this).attr('colspan');
                        var hideCols = $(this).attr('omics-ss-hideable-study-cols');
                        $(this).attr('colspan', colspan - hideCols);
                    }
                });

                $(this).attr('assay-hide-mode', '1');
            }

            // Show
            else {
                $(this).find('i').removeClass('fa-eye-slash');
                $(this).find('i').addClass('fa-eye');
                $(this).closest('.omics-ss-data-card').find('.omics-ss-data-table').find('.omics-ss-hideable-study').show();
                $(this).closest('.omics-ss-data-card').find('.omics-ss-data-table').find('.omics-ss-top-header').each(function () {
                    if ($(this).attr('omics-ss-hideable-study-cols') !== '0') {
                        var originalCols = $(this).attr('original-colspan');
                        $(this).attr('colspan', originalCols);
                    }
                });

                $(this).attr('assay-hide-mode', '0');
            }
        });
    });
  </script>

  <!--
  <script type="text/javascript" src="https://cdn.rawgit.com/asvd/dragscroll/master/dragscroll.js"></script>
  -->

  {# Tour content #}
  <script type="text/javascript">
    tourEnabled = false;
  </script>
{% endblock javascript %}
