{# Projectroles dependency #}
{% extends 'projectroles/project_base.html' %}
{% load projectroles_common_tags %}

{% load static %}
{% load rules %}
{% load landingzones_tags %}

{% block title %}
  Landing Zones for {{ project.title }}
{% endblock title %}

{% block css %}
  {{ block.super }}
  <style type="text/css">
    .omics-lz-table td:first-child {
      // white-space: nowrap;
    }

    .omics-lz-table thead tr th:nth-child(3) {
      width: 350px !important;
    }

    .omics-lz-table thead tr th:nth-child(4) {
      width: 120px !important;
    }

    .omics-lz-table thead tr th:nth-child(5) {
      width: 120px !important;
      white-space: nowrap !important;
    }

    .omics-lz-table thead tr th:nth-child(6) {
      width: 70px !important;
    }

    /* Responsive modifications */
    @media screen and (max-width: 1300px) {
      .table.omics-lz-table tr th:nth-child(3) {
        display: none;
      }
      .table.omics-lz-table tr td:nth-child(3) {
        display: none;
      }
    }

    @media screen and (max-width: 800px) {
      .table.omics-lz-table tr th:nth-child(2) {
        display: none;
      }
      .table.omics-lz-table tr td:nth-child(2) {
        display: none;
      }
    }

    @media screen and (max-width: 600px) {
      .table.omics-lz-table tr th:nth-child(4) {
        display: none;
      }
      .table.omics-lz-table tr td:nth-child(4) {
        display: none;
      }
    }

    @media screen and (max-width: 450px) {
      .table.omics-lz-table tr th:nth-child(5) {
        display: none;
      }
      .table.omics-lz-table tr td:nth-child(5) {
        display: none;
      }
    }

  </style>
{% endblock css %}

{% block projectroles_extend %}
{% has_perm 'landingzones.update_zones_own' request.user project as can_update_zones_own %}
{% has_perm 'landingzones.update_zones_all' request.user project as can_update_zones_all %}
{% has_perm 'landingzones.add_zones' request.user project as can_add_zones %}

<div class="row omics-subtitle-container bg-white sticky-top">
  <h3><i class="fa fa-database"></i> Landing Zones</h3>
  {% if can_add_zones %}
    {% include 'landingzones/_list_buttons.html' %}
  {% endif %}
</div>

<div class="container-fluid omics-page-container"> {# Main container #}

  {% if not investigation %}
    <div class="alert alert-danger" role="alert" id="omics-lz-alert-no-zones">
      <strong>Note:</strong> No sample sheets are currently available for this project.
      To create landing zones, a person with sufficient project permissions must
      import an ISAtab investigation and create the sample directory structure in iRODS
      using the <a href="{% url 'samplesheets:project_sheets' project=project.omics_uuid %}">Sample Sheets</a> app.
    </div>

  {% elif investigation and not investigation.irods_status %}
    <div class="alert alert-danger" role="alert" id="omics-lz-alert-no-zones">
      <strong>Note:</strong> The iRODS directory structure for the project sample
      sheets is not available. A user authorized for sample sheet editing must
      enable iRODS access by selecting <cite>"Create in iRODS"</cite> in the
      <a href="{% url 'samplesheets:project_sheets' project=project.omics_uuid %}">Sample Sheets</a> app.
      After that landing zones can be created for the project.
    </div>

  {% elif zones_own.count == 0 and not zones_other %}
    <div class="alert alert-info" role="alert" id="omics-lz-alert-no-zones">
      No landing zones are currently available for you in this project. Please
      create a landing zone for a desired assay using the "Zone Operations" menu.
    </div>

  {% else %}
    {# User zones #}
    {% if zones_own.count > 0 %}
      {% include 'landingzones/_zone_list.html' with zones=zones_own list_title='Your Zones' list_icon='fa-user' list_type='own' %}
    {% endif %}
    {% if zones_other %}
      {% include 'landingzones/_zone_list.html' with zones=zones_other list_title='Other Zones' list_icon='fa-users' list_type='other' %}
    {% endif %}
  {% endif %}

</div> {# Main container #}

<span class="omics-popup-overlay" id="omics-lz-popup-list" list-url="" zone-title=""></span>
<span class="omics-popup-overlay" id="omics-lz-popup-cmd" irods-path="" zone-title=""></span>

{% endblock projectroles_extend %}

{% block javascript %}
  {{ block.super }}

  <!-- Clipboard helper -->
  <script type="text/javascript" src="{% static 'js/clipboard.min.js' %}"></script>

  <script type="text/javascript">
    /**************
     Init clipboard
     **************/
    new ClipboardJS('.omics-copy-btn');

    /*****************************
     Zone status updating function
     *****************************/
    var updateZoneStatus = function() {
        $('.omics-lz-zone-tr-existing').each(function(){
            var trId = $(this).attr('id');
            var zoneUuid = $(this).attr('zone-uuid');
            var sampleUrl = $(this).attr('sample-url');

            if ($(this).find('td.omics-lz-zone-status').text() !== 'MOVED') {
                $.ajax({
                    url: $(this).attr('status-url'),
                    method: 'GET',
                    dataType: 'json'
                }).done(function (data) {
                    // console.log(trId + ': ' + data['status']);  // DEBUG
                    zoneTr = $('#' + trId);
                    statusTd = zoneTr.find('td#omics-lz-zone-status-' + zoneUuid);

                    // TODO: Should somehow get these from STATUS_STYLES instead
                    var statusStyles = {
                        'CREATING': 'bg-warning',
                        'NOT CREATED': 'bg-danger',
                        'ACTIVE': 'bg-info',
                        'PREPARING': 'bg-warning',
                        'VALIDATING': 'bg-warning',
                        'MOVING': 'bg-warning',
                        'MOVED': 'bg-success',
                        'FAILED': 'bg-danger'
                    };

                    if (statusTd.text() !== data['status'] ||
                            zoneTr.find('td.omics-lz-zone-status-info').text() !== data['status_info']) {
                        zoneTr.find('td.omics-lz-zone-status-info').text(data['status_info']);
                        statusTd.text(data['status']);
                        statusTd.removeClass();
                        statusTd.addClass(statusStyles[data['status']] + ' text-white');

                        // Status info modification
                        if (data['status'] !== 'NOT CREATED' && data['status'] !== 'CREATING' && data['status'] !== 'MOVED') {
                            var fileSuffix = 's';

                            if (data['file_count'] === 1) {
                                fileSuffix = '';
                            }

                        zoneTr.find('td.omics-lz-zone-status-info').append(
                            '<br /><span class="badge badge-info">' + data['file_count'] +
                            ' data file' + fileSuffix +
                            ' ('+ humanFileSize(data['total_size'], true) + ')</span>');
                        }

                        else if (data['status'] === 'MOVED') {
                            zoneTr.find('td.omics-lz-zone-status-info').append(
                                '<br /><a href="' + sampleUrl + '"><i class="fa fa-arrow-circle-right"></i> ' +
                                'Browse files in sample sheet</a>');
                        }

                        // Button modification
                        if (data['status'] !== 'ACTIVE' && data['status'] !== 'FAILED') {
                            zoneTr.find('td.omics-lz-zone-title').addClass('text-muted');
                            zoneTr.find('td.omics-lz-zone-assay').addClass('text-muted');
                            zoneTr.find('td.omics-lz-zone-status-info').addClass('text-muted');

                            zoneTr.find('.btn').each(function() {
                               if ($(this).is('button')) {
                                   $(this).attr('disabled', 'disabled');
                               }

                               else if ($(this).is('a')) {
                                   $(this).addClass('disabled');
                               }

                               $(this).tooltip('disable');
                            });

                            zoneTr.find('.omics-edit-dropdown').addClass('disabled');
                        }

                        else {
                            var webDavEnabled = {{ irods_webdav_enabled }};

                            zoneTr.find('td.omics-lz-zone-title').removeClass('text-muted');
                            zoneTr.find('td.omics-lz-zone-assay').removeClass('text-muted');
                            zoneTr.find('td.omics-lz-zone-status-info').removeClass('text-muted');

                            // TODO: Enable/disable individually instead of looping..
                            zoneTr.find('.btn').each(function() {
                                if ($(this).is('button')) {
                                    $(this).removeAttr('disabled');
                                }

                                // TODO: ..because this is rather ugly
                                else if ($(this).is('a') &&
                                        (!$(this).hasClass('omics-lz-dav-btn') || webDavEnabled === true)) {
                                    $(this).removeClass('disabled');
                                }

                               $(this).tooltip('enable');
                            });

                            zoneTr.find('.omics-edit-dropdown').removeClass('disabled');
                        }
                    }
                });
            }
        });
    };

    $(document).ready(function() {
        /******************
         Update zone status
         ******************/
        updateZoneStatus();
        var statusInterval = {{ zone_status_interval }} * 1000;

        // Poll and update active zones
        var interval = setInterval(function () {
            updateZoneStatus();
        }, statusInterval);

        /***************
         Link list Popup
         ***************/
        $('#omics-lz-popup-list').popup({
            transition: 'all 0.2s',
            beforeopen: function () {
                var listUrl = $(this).attr('list-url');
                var zoneTitle = $(this).attr('zone-title');
                var htmlHeader = '<div class="card"><div class="card-body"><h5>iRODS File List for Zone "' + zoneTitle + '"</h5><hr />';
                var htmlFooter = '</div></div>';
                var htmlData = '';

                $.ajax({
                    url: listUrl,
                    method: 'GET',
                    dataType: 'json'
                }).done(function (data) {
                    // console.log(data);  // DEBUG

                    if (data['data_objects'].length > 0) {
                        htmlData = '<table class="table omics-card-table table-striped omics-irods-obj-table">';
                        htmlData += '<thead><th>File</th><th>Size</th><th>Modified</th><th>MD5</th></thead><tbody>';

                        $.each(data['data_objects'], function (i, obj) {
                            var objNameSplit = obj['path'].split('/');
                            var objLink = '<a href="{{ irods_webdav_url }}' + obj['path'] + '"><span class="text-muted">';
                            // TODO: Find by zoneTitle instead of directly splicing
                            objLink += objNameSplit.slice(10, objNameSplit.length - 1).join('/');
                            objLink += '/</span>' + obj['name'] + '</a>';
                            htmlData += '<tr><td>' + objLink + '</td>';
                            htmlData += '<td>' + humanFileSize(obj['size'], true) + '</td>';
                            htmlData += '<td>' + obj['modify_time'] + '</td>';
                            htmlData += '<td>';

                            if (obj['md5_file'] === true) {
                                htmlData += '<span class="text-muted"><i class="fa fa-check"></i></span>';
                            }

                            else {
                                htmlData += '<span class="text-danger"><i class="fa fa-close"></i></span>';
                            }

                            htmlData += '</td></tr>';
                        });
                    }

                    else {
                        htmlData = popupNoFilesHtml;
                    }

                    // Set success html
                    $('#omics-lz-popup-list').html(htmlHeader + htmlData + htmlFooter);
                }).fail(function (response) {
                    $('#omics-ss-popup-list').html(htmlHeader +
                        '<span class="text-danger font-italic">Failed to query data (' +
                        response.status + ': ' + response.responseText + ')</span>' + htmlFooter);
                });

            // Set default loading html
            $(this).html(popupWaitHtml);
            }
        });

        $('.omics-lz-popup-list-btn').click(function() {
            if ($(this).closest('tr').find('td.omics-lz-zone-status').text() !== 'MOVED') {
                $('#omics-lz-popup-list').attr(
                    'list-url', $(this).attr('list-url')).attr(
                      'zone-title', $(this).attr('zone-title')).popup('show');
            }
        });

        /**************
         iCommand Popup
         **************/
        // TODO: Unify this with the landingzones iCommand popup
        $('#omics-lz-popup-cmd').popup({
            transition: 'all 0.2s',
            beforeopen: function () {
                var irodsPath = $(this).attr('irods-path');
                var zoneTitle = $(this).attr('zone-title');
                var htmlHeader = '<div class="card"><div class="card-body"><h5>iRODS iCommands Access to Zone "' + zoneTitle + '"</h5><hr />';
                var htmlFooter = '</div></div>';
                var htmlData = '<div class="input-group">' +
                    '<input id="omics-copy-field" class="form-control omics-code-input" type="text" value="icd ' + irodsPath + '" readonly/>' +
                    '<div class="input-group-append">' +
                    '<button class="btn btn-secondary omics-copy-btn" role="submit" data-clipboard-target="#omics-copy-field"><i class="fa fa-clipboard"></i> Copy</button></div>' +
                    '</div>';

                // Set html
                $('#omics-lz-popup-cmd').html(htmlHeader + htmlData + htmlFooter);
            }
        });

        $('.omics-lz-popup-cmd-btn').click(function() {
            if ($(this).closest('tr').find('td.omics-lz-zone-status').text() !== 'MOVED') {
                $('#omics-lz-popup-cmd').attr(
                    'irods-path', $(this).attr('irods-path')).attr(
                        'zone-title', $(this).attr('zone-title')).popup('show');
            }
        });
    });
  </script>

  {# Tour content #}
  <script type="text/javascript">
    tourEnabled = true;

    tour.addStep('zone_info', {
        title: 'Landing Zones',
        text: 'In this app you are able to create and manage personal ' +
              'landing zones for uploading data to the project sample ' +
              'repository in iRODS.',
        advanceOn: '.docs-link click',
        showCancelLink: true
    });

    // No zones
    if ($('#omics-lz-alert-no-zones').length) {
        tour.addStep('no_zones', {
            title: 'No Landing Zones Available',
            text: 'No landing zones are currently available. See the alert ' +
                  'box for instruction on how to proceed.',
            attachTo: '#omics-lz-alert-no-zones top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });
    }

    if ($('#omics-lz-zone-list-own').length) {
        tour.addStep('own_zones', {
            title: 'Your Own Zones',
            text: 'Your own landing zones are listed in this table.',
            attachTo: '#omics-lz-zone-list-own top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });
    }

    if ($('#omics-lz-zone-list-other').length) {
        tour.addStep('other_zones', {
            title: 'Zones of Other Users',
            text: 'This table lists zones of other users to which you have ' +
                  'been given access.',
            attachTo: '#omics-lz-zone-list-other top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });
    }

    if ($('#omics-lz-buttons-list').length) {
        tour.addStep('zone_operations', {
            title: 'Zone Operations',
            text: 'Create new zones or clear existing moved zones from this ' +
                  'menu.',
            attachTo: '#omics-lz-buttons-list left',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });
    }

    // Table data
    if ($('.omics-lz-table').length) {
        tour.addStep('zone_title', {
            title: 'Zone Title',
            text: 'The title of each stone is shown in this column. This ' +
                  'takes the form of a timestamp and an arbitrary suffix.',
            attachTo: '.omics-lz-list-header-title top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('zone_assay', {
            title: 'Zone Assay',
            text: 'Each landing zone is specific to one assay within the ' +
                  'project studies.',
            attachTo: '.omics-lz-list-header-assay top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('zone_status', {
            title: 'Zone Status',
            text: 'The status of each landing zone can be seen in this ' +
                  'column. Available actions depend on the current status. ' +
                  '"ACTIVE" zones are ones in which you can freely upload ' +
                  'and modify files.',
            attachTo: '.omics-lz-list-header-status top',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('zone_links', {
            title: 'iRODS Links for Zone',
            text: 'Links for iRODS access for available zone are presented ' +
                  'in this column.',
            attachTo: '.omics-lz-zone-links left',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });

        tour.addStep('zone_edit', {
            title: 'Zone Specific Operations',
            text: 'In this column, you can trigger the data validation and ' +
                  'moving operation for moving your landing zone content ' +
                  'into the project sample repository. Here you can also ' +
                  'delete unwanted landing zones.',
            attachTo: '.omics-lz-zone-edit left',
            advanceOn: '.docs-link click',
            showCancelLink: true
        });
    }

  </script>
{% endblock javascript %}
