{% load rules %}
{% load projectroles_tags %}

{% has_perm 'projectroles.view_project' request.user project as can_view_project %}
{% has_perm 'projectroles.view_project_roles' request.user project as can_view_roles %}
{% has_perm 'projectroles.update_project' request.user project as can_update_project %}
{% has_perm 'projectroles.create_project' request.user project as can_create_project %}
{% has_perm 'projectroles.update_project_settings' request.user project as can_update_settings %}

{% omics_constant 'PROJECT_TYPE_CATEGORY' as PROJECT_TYPE_CATEGORY %}

<div class="row">
  {% comment %}
    {% include 'projectroles/_project_list_dropdown.html' %}
  {% endcomment %}

  <div class="btn-group pull-right" id="pr_buttons_project_menu">
    {% if request.resolver_match.url_name == 'project_detail' %}
      <a class="btn btn-secondary" role="button" id="pr_buttons_back_overview" href="{% url 'home' %}">
        <i class="fa fa-arrow-circle-left" aria-hidden="true"></i>
        Back to Home</a>
    {% elif request.resolver_match.url_name == 'role_update' %}
      <a class="btn btn-secondary" role="button" id="pr_buttons_back_roles" href="{% url 'project_roles' pk=project.pk %}">
        <i class="fa fa-arrow-circle-left" aria-hidden="true"></i>
        Back to Roles</a>
    {% else %}
      <a class="btn btn-secondary" role="button" id="pr_buttons_back_project" href="{% url 'project_detail' pk=project.pk %}">
        <i class="fa fa-arrow-circle-left" aria-hidden="true"></i>
        Back to Project</a>
    {% endif %}
    <div class="btn-group" id="pr_buttons_project_group">
      <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Project Menu
      </button>
      <div class="dropdown-menu dropdown-menu-right">

        {# App plugins #}
        {% if project.type != PROJECT_TYPE_CATEGORY %}
          {% for plugin in app_plugins %}
            {% has_perm plugin.app_permission request.user project as can_view_app %}
            {% if can_view_app %}
              <a class="dropdown-item"
                 href="{% url plugin.entry_point_url_id project=project.pk %}"
                 title="{{ plugin.title }}"
                 id="pr_app_plugin_buttons_{{ plugin.pk }}">
                 <i class="fa fa-{{ plugin.icon }}" aria-hidden="true"></i>
                {{ plugin.title }}
              </a>
            {% endif %}
          {% endfor %}
        {% endif %}

        {# Role and project editing #}
        {% if project.type != PROJECT_TYPE_CATEGORY and can_view_roles %}
          <a class="dropdown-item"
              href="{% url 'project_roles' pk=project.pk %}"
              title="User Roles"
              id="pr_project_buttons_roles">
            <i class="fa fa-users" aria-hidden="true"></i>
            User Roles
          </a>
        {% endif %}
        {% if project.type != PROJECT_TYPE_CATEGORY and can_update_settings %}
          <a class="dropdown-item"
              href="{% url 'settings_update' project=project.pk %}"
              title="Project Settings"
              id="pr_project_buttons_settings">
            <i class="fa fa-wrench" aria-hidden="true"></i>
            Project Settings
          </a>
        {% endif %}
        {% if can_update_project %}
          <a class="dropdown-item"
              href="{% url 'project_update' pk=project.pk %}"
              title="Update Project"
              id="pr_project_buttons_update">
            <i class="fa fa-pencil" aria-hidden="true"></i>
            Update Project
          </a>
        {% endif %}
        {% if not project.parent and can_create_project %}
          <a class="dropdown-item"
              href="{% url 'project_create' parent=project.pk %}"
              title="Create Subproject"
              id="pr_project_buttons_create">
            <i class="fa fa-cube" aria-hidden="true"></i>
            Create Subproject
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <h2 style="display: inline;">
    {% if project.parent %}
      {{ project.parent.title }} /
    {% endif %}
    {{ project.title }}
  </h2>
</div>

{# TODO: Replace this temp HACK with proper CSS :) #}
<div class="row" style="padding-top: 8px; padding-bottom: 16px;">
  <hr />
</div>
